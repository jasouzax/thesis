% Packages
\usepackage{fancyvrb}   % provides VerbatimOut to capture verbatim to a file
\usepackage{ifthen}
\usepackage{svg} 

\newcommand{\plantumltype}{png}

% Counter for unique names
\newcounter{plantumlctr}

% New environment
\newenvironment{plantuml}{
  \refstepcounter{plantumlctr}
  \VerbatimEnvironment
  \begin{VerbatimOut}{uml-\theplantumlctr.puml}%
}{
  \end{VerbatimOut}
  \immediate\write18{java -jar "plantuml.jar" -t\plantumltype\space "uml-\theplantumlctr.puml"}
  \begin{center}
    \ifthenelse{\equal{\plantumltype}{png}}{
      \includegraphics[width=\linewidth]{uml-\theplantumlctr.png}
    }{
      \includesvg[width=\linewidth]{uml-\theplantumlctr.svg}
    }
  \end{center}
}